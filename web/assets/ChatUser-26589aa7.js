import{r as l,C as $,a as i,j as e,F as C,b as v,u as I}from"./index-c059fe49.js";import{u as P}from"./user-ca0d8e03.js";import{B}from"./button-8a20b2ea.js";import{a as H,b as z,c as O,S as W}from"./card-911daa80.js";import{$ as Y,d as N,_ as S,c as G,e as E}from"./index-e27f2a65.js";import{c as _}from"./utils-587908ec.js";import"./index-7e7c04ab.js";let q="/";function K(s){const[a,n]=l.useContext($),t=s.message,c=t.user_id?"items-start":"items-end",d=c=="items-start"?"bg-blue-100":"bg-blue-300",o=t.date?new Date(t.date*1e3):new Date;let f=o.getDate()<10?"0"+o.getDate():o.getDate(),u=o.getMonth()+1<10?"0"+(o.getMonth()+1):o.getMonth()+1,g=o.getFullYear(),m=f+"/"+u+"/"+g,r=o.getHours()<10?"0"+o.getHours():o.getHours(),h=o.getMinutes()<10?"0"+o.getMinutes():o.getMinutes();m+=" "+r+":"+h;const x=s.replyTo,p=w=>{const y=w.file;if(y&&y.type=="photo")return e("img",{src:q+y.file_name,loading:"lazy",className:"w-full h-full select-none"})},b=()=>{n({type:"SET_REPLY_TO",payload:t})};return i("div",{className:"w-full py-2 flex flex-col justify-start "+c,onDoubleClick:b,children:[i("div",{className:d+" shadow-md min-w-min max-w-lg whitespace-pre-wrap",children:[!!x&&i("div",{className:"bg-blue-200 shadow-md text-gray-600 border-l-2 border-blue-400"+(x.file?" mx-2 mt-2":" mx-1 mt-1"),children:[p(x),!!x.text&&e("div",{className:"px-2 py-1",children:x.text})]}),p(t),!!t.text&&e("div",{className:"px-2 py-1 mx-1 text-gray-800",children:t.text})]}),e("span",{className:"text-xs py-1 text-gray-400 select-none",children:m})]})}let J="/";function U({chatId:s}){const[a,n]=l.useContext($),[t,c]=l.useState(""),[d,o]=l.useState(null),[f,u]=l.useState(null),g=async p=>{if(p.preventDefault(),t==""&&!d)return;const b=new FormData;b.append("text",t),a.replyTo&&(data.message_id=a.replyTo.id,b.append("message_id",a.replyTo.id)),d&&b.append("file",d),await v.post(`/api/v1/chat/${s}`,b,{headers:{"Content-Type":"multipart/form-data"}}).then(w=>{console.log(w);const D=w.data.data;n({type:"SET_MESSAGES",payload:[...a.messages,D]}),c(""),n({type:"SET_REPLY_TO",payload:null}),o(null),u(null)}).catch(w=>{console.log(w)})},m=p=>{p.keyCode==13&&p.shiftKey==!1&&(p.preventDefault(),g(p))},r=()=>{n({type:"SET_REPLY_TO",payload:null})};l.useEffect(()=>{c(""),n({type:"SET_REPLY_TO",payload:null})},[s]);const h=p=>{const b=p.target.files[0];b&&(o(b),u(URL.createObjectURL(b)))},x=()=>{o(null),u(null)};return i(C,{children:[!!a.replyTo&&i("div",{className:"text-gray-500 flex items-center justify-between mb-5",children:[e("div",{className:"flex items-center",children:i("svg",{xmlns:"http://www.w3.org/2000/svg",className:"icon icon-tabler icon-tabler-corner-up-left",width:"24",height:"24",viewBox:"0 0 24 24",strokeWidth:"2",stroke:"currentColor",fill:"none",strokeLinecap:"round",strokeLinejoin:"round",children:[e("path",{stroke:"none",d:"M0 0h24v24H0z",fill:"none"}),e("path",{d:"M18 18v-6a3 3 0 0 0 -3 -3h-10l4 -4m0 8l-4 -4"})]})}),i("div",{className:"w-full px-4 text-left flex",children:[!!a.replyTo.file&&a.replyTo.file.type=="photo"&&e("div",{className:"mr-3",children:e("img",{src:J+a.replyTo.file.file_name,alt:"",className:"w-10",loading:"lazy"})}),e("div",{children:a.replyTo.text})]}),e("div",{className:"flex items-center",children:e("button",{onClick:r,children:i("svg",{xmlns:"http://www.w3.org/2000/svg",className:"icon icon-tabler icon-tabler-x",width:"24",height:"24",viewBox:"0 0 24 24",strokeWidth:"2",stroke:"currentColor",fill:"none",strokeLinecap:"round",strokeLinejoin:"round",children:[e("path",{stroke:"none",d:"M0 0h24v24H0z",fill:"none"}),e("path",{d:"M18 6l-12 12"}),e("path",{d:"M6 6l12 12"})]})})})]}),!!f&&i("div",{className:"text-gray-500 flex items-center justify-between mb-3",children:[e("div",{className:"w-full",children:e("img",{src:f,alt:"",className:"w-1/3",loading:"lazy"})}),e("div",{className:"flex items-center",children:e("button",{onClick:x,children:i("svg",{xmlns:"http://www.w3.org/2000/svg",className:"icon icon-tabler icon-tabler-x",width:"24",height:"24",viewBox:"0 0 24 24",strokeWidth:"2",stroke:"currentColor",fill:"none",strokeLinecap:"round",strokeLinejoin:"round",children:[e("path",{stroke:"none",d:"M0 0h24v24H0z",fill:"none"}),e("path",{d:"M18 6l-12 12"}),e("path",{d:"M6 6l12 12"})]})})})]}),i("form",{className:"w-full bg-white shadow flex",onSubmit:g,children:[i("div",{className:"flex-1 flex items-center",children:[e("div",{className:"pl-4 text-gray-500 cursor-pointer",children:e("div",{className:"flex w-full items-center justify-center",children:i("label",{className:"flex flex-col items-center cursor-pointer",title:"Upload Image",children:[i("svg",{xmlns:"http://www.w3.org/2000/svg",className:"w-6 h-6",viewBox:"0 0 24 24",strokeWidth:"1.5",stroke:"#2c3e50",fill:"none",strokeLinecap:"round",strokeLinejoin:"round",children:[e("path",{stroke:"none",d:"M0 0h24v24H0z",fill:"none"}),e("line",{x1:"15",y1:"8",x2:"15.01",y2:"8"}),e("rect",{x:"4",y:"4",width:"16",height:"16",rx:"3"}),e("path",{d:"M4 15l4 -4a3 5 0 0 1 3 0l5 5"}),e("path",{d:"M14 14l1 -1a3 5 0 0 1 3 0l2 2"})]}),e("input",{type:"file",onChange:h,accept:"image/*",className:"hidden"})]})})}),e("textarea",{name:"",rows:"1",className:"w-full block outline-none py-3 px-4 bg-transparent border-none  focus:ring-0 resize-none",placeholder:"Type a message...",value:t,onChange:p=>c(p.target.value),onKeyDown:m})]}),e("div",{className:"flex-2 flex justify-center",children:e(B,{type:"submit",className:"h-full",children:"Send"})})]})]})}const T="Avatar",[V,ue]=Y(T),[Q,k]=V(T),X=l.forwardRef((s,a)=>{const{__scopeAvatar:n,...t}=s,[c,d]=l.useState("idle");return l.createElement(Q,{scope:n,imageLoadingStatus:c,onImageLoadingStatusChange:d},l.createElement(N.span,S({},t,{ref:a})))}),Z="AvatarImage",ee=l.forwardRef((s,a)=>{const{__scopeAvatar:n,src:t,onLoadingStatusChange:c=()=>{},...d}=s,o=k(Z,n),f=se(t),u=G(g=>{c(g),o.onImageLoadingStatusChange(g)});return E(()=>{f!=="idle"&&u(f)},[f,u]),f==="loaded"?l.createElement(N.img,S({},d,{ref:a,src:t})):null}),te="AvatarFallback",ae=l.forwardRef((s,a)=>{const{__scopeAvatar:n,delayMs:t,...c}=s,d=k(te,n),[o,f]=l.useState(t===void 0);return l.useEffect(()=>{if(t!==void 0){const u=window.setTimeout(()=>f(!0),t);return()=>window.clearTimeout(u)}},[t]),o&&d.imageLoadingStatus!=="loaded"?l.createElement(N.span,S({},c,{ref:a})):null});function se(s){const[a,n]=l.useState("idle");return E(()=>{if(!s){n("error");return}let t=!0;const c=new window.Image,d=o=>()=>{t&&n(o)};return n("loading"),c.onload=d("loaded"),c.onerror=d("error"),c.src=s,()=>{t=!1}},[s]),a}const A=X,L=ee,M=ae,R=l.forwardRef(({className:s,...a},n)=>e(A,{ref:n,className:_("relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full",s),...a}));R.displayName=A.displayName;const j=l.forwardRef(({className:s,...a},n)=>e(L,{ref:n,className:_("aspect-square h-full w-full",s),...a}));j.displayName=L.displayName;const ne=l.forwardRef(({className:s,...a},n)=>e(M,{ref:n,className:_("flex h-full w-full items-center justify-center rounded-full bg-muted",s),...a}));ne.displayName=M.displayName;let F;F="/storage/profiles/";function me(){var g;const{chatId:s}=I(),[a,n]=l.useContext($),[t,c]=l.useState({}),d=async()=>{const r=(await v.get(`/api/v1/chat/${s}`)).data.data;if(c(r),n({type:"SET_MESSAGES",payload:r==null?void 0:r.messages}),r!=null&&r.unread_messages&&(r==null?void 0:r.unread_messages)>0){v.post(`/api/v1/chat/${r.id}/read`);const h=a.unread-r.unread_messages;n({type:"SET_UNREAD",payload:h})}},o=t!=null&&t.profile_photo?F+t.profile_photo:P,f=l.useRef(null),u=()=>{f.current.scrollTop=f.current.scrollHeight*2};return l.useEffect(()=>{d(),u();const m=new WebSocket(`ws://localhost:8080/ws/chat/${s}`);return m.onopen=r=>{console.log("connected chat user")},m.onmessage=r=>{const h=JSON.parse(r.data);window.location.pathname.includes(`/chat/${h.id}`)&&n({type:"SET_MESSAGES",payload:[...a.messages,h.message]})},()=>{console.log("cleanup chat user"),m.close()}},[s]),l.useEffect(()=>{u()},[a.messages]),i(C,{children:[i(H,{className:"border-b flex flex-row items-center",children:[e(R,{className:"mr-4",children:e(j,{src:o,alt:"profil"})}),i("div",{children:[e(z,{children:(t==null?void 0:t.first_name)+" "+(t==null?void 0:t.last_name)}),e(O,{children:t==null?void 0:t.username})]})]}),e(W,{className:"chat h-full px-4 py-3",ref:f,children:(g=a.messages)==null?void 0:g.map((m,r)=>{let h=null;return m.message_id&&(h=a.messages.find(x=>x.id==m.message_id)),e(K,{message:m,replyTo:h},r)})}),e("div",{className:"w-full bg-gray-100 px-4 py-5",children:e(U,{chatId:s})})]})}export{me as default};
